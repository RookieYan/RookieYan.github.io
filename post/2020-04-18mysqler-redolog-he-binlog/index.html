<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title> [2020-04-18]MySQL（二）RedoLog和BinLog | 闫。</title>
<meta name="description" content="一个白痴">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="shortcut icon" href="https://RookieYan.github.io/favicon.ico?v=1588359188349">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="stylesheet" href="https://unpkg.com/papercss@1.6.1/dist/paper.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://RookieYan.github.io/styles/main.css">


<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>


<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />


  </head>
  <body>
  
    <nav class="navbar border fixed split-nav">
  <div class="nav-brand">
    <h3><a href="https://RookieYan.github.io">闫。</a></h3>
  </div>
  <div class="collapsible">
    <input id="collapsible1" type="checkbox" name="collapsible1">
    <button>
      <label for="collapsible1">
        <div class="bar1"></div>
        <div class="bar2"></div>
        <div class="bar3"></div>
      </label>
    </button>
    <div class="collapsible-body">
      <ul class="inline">
        
          <li>
            
              <a href="/" class="menu">
                首页
              </a>
            
          </li>
        
          <li>
            
              <a href="/archives" class="menu">
                归档
              </a>
            
          </li>
        
          <li>
            
              <a href="/tags" class="menu">
                标签
              </a>
            
          </li>
        
          <li>
            
              <a href="/post/about" class="menu">
                关于
              </a>
            
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div id="top" class="row site">
      <div class="sm-12 md-8 col">
        <div class="paper">
          <article class="article">
            <h1> [2020-04-18]MySQL（二）RedoLog和BinLog</h1>
            <p class="article-meta">
              2020-05-02
              
                <a href="https://RookieYan.github.io/tag/A0v8BAYSM/" class="badge secondary">
                  MySQL
                </a>
              
            </p>
            
            <div class="post-content">
              <!-- more -->
<p>  今天说一下MySQL的两个日志模块，分别是BinLog和RedoLog。<br>
  可能有的研发同学会听到DBA同事说MySQL可以恢复到半个月内的任意一秒的状态，在惊奇的同时，可能会好奇是怎么实现的。我们今天就来聊聊这个事儿。</p>
<p>  假如我们现在有一张表T，只有主键Id和一个整型字段 c，然后现在我们要将Id=2这一行的值加1，那么SQL语句应该这么写：</p>
<pre><code>update T set c=c+1 where ID=2;
</code></pre>
<p>  从上一篇<a href="https://rookieyan.github.io/post/2020-04-18mysqlyi-sql-de-zhi-xing-liu-cheng/">MySQL（一）SQL的执行流程</a>我们基本可以很明确这条更新的SQL语句的执行流程会和查询流程一样把整个流程走一遍。前面我们也有说过，在对表做更新操作的时候，跟这个表有关的查询缓存会失效，所以这条语句的执行会把表T上的查询缓存中结果都清空。这也是我们一般不建议使用查询缓存的原因。<br>
<img src="https://RookieYan.github.io/post-images/1588350320310.png" alt="" loading="lazy"><br>
  接下来分析器会通过词法和语法解析知道这是一条更新语句。优化器会决定要使用ID对应的主键索引。执行器负责具体的执行操作，找到对应的这一行，然后更新。</p>
<p>  和查询流程不一样的是，在更新流程中，会涉及到两个比较重要的日志模块。他们正是我们今天要讨论的主角：<strong>redolog（重做日志）和binlog（归档日志）</strong>。 如果接触过MySQL，那么这两个词肯定是绕不过去的。并且这两个日志模块在设计上也有很多有意思的地方，可以将设计思路运用到自己平时的设计和开发中。</p>
<h2 id="1-redo-log"><strong>1. redo log</strong></h2>
<p>  有一个🌰可以很好的解释这个日志模块。《孔乙己》那篇文章中，酒馆老板有一个小黑板和一本账本，专门记录客人赊账的情况。如果有人要赊账或者还账的话，酒馆老板一般有两种做法：</p>
<ul>
<li>把账本翻出来，找到客人对应的记录，做更新操作。</li>
<li>先在小黑板上记录下来这次的帐，等到打烊后再把账单翻出来核算。</li>
</ul>
<p>  在生意比较忙碌的情况下，酒馆老板一定会选择后者，因为前者是在太麻烦了，需要从账本中准确找到客人的记录（可能还没有索引），数目比较大的话可能还需要用算盘算一下，最后再把结果写到账本上。如果比较忙的情况下。这种方式一定是不可取的。 不如先写在小黑板上，等到空闲的时候，再去把账目同步到账本上。</p>
<p>  同样的在MySQL中也有相似的问题，每一次的更新操作都需要写进磁盘里，然后磁盘也需要找到对应的记录做更新操作。整个过程的IO成本和查找成本都是比较高的。为了解决这个问题，MySQL的设计者就想到了类似于酒馆老板记账的思路来提升效率，减少IO。</p>
<p>  所以小黑板和账单配合的过程，就是MySQL里经常说到的<strong>WAL技术，WAL技术的全称是Write-Ahead Logging，它的关键点就是先写日志，再写磁盘，也就是先写粉板，等不忙的时候再写账本。</strong></p>
<p>  具体来说就是，当有一条记录需要被更新的时候，InnoDB引擎就会先把记录给写到redo log中（小黑板），并且更新内存。 这个时候更新就算完成了。 同时InnoDB会在比较合适的时候，把这个操作记录更新到磁盘中，而这个更新一般会是在系统比较空闲的时候去做的（类似于老板打烊后做的事儿）。</p>
<p>  当然你可能会问，会不会有一种情况，就是今天生意太好了，小黑板都被写满了，那怎么办呢？ 如果是这种情况的话，那么只能让老板停下手中的活，先去把账本更新了，然后擦除黑板上的记录，腾出空间，再写上新的记录。InnoDB的redo log是固定大小的，比如可以配置一组是4个文件，每个文件小为1G，那么这块“小黑板”总共就可以记录4G的操作记录，从头开始写，写到末尾就再从头开始写。如下图所示：<br>
<img src="https://RookieYan.github.io/post-images/1588354832158.png" alt="" loading="lazy"><br>
  write pos是当前记录的位置，一边写一边后移，写到LogFile3的末尾就到了LogFile0的开头继续写，check point是当前要擦除的位置，也是一样要往后移并且循环的，擦除记录前要把记录更新到数据文件中。</p>
<p>  write pos 和 checkpoint 之间的绿色部分是“小黑板”上还空着的部分，可以用来记录新的操作。如果 write pos 追上 checkpoint，表示“小黑板”满了，这时候不能再执行新的更新，得停下来先擦掉一些记录，把 checkpoint 推进一下。</p>
<p>  至此，有了redolog，InnoDB就可以保证数据在发生数据库异常重启的时候，之前提交的数据都不会丢失，这个能力称为<strong>crash-safe</strong>。</p>
<h2 id="2-bin-log"><strong>2. bin log</strong></h2>
<pre><code>未完待续....
</code></pre>

            </div>
          </article>
        </div>
        <div class="paper" data-aos="fade-in">
          
            <div class="next-post">
              <div class="next">
                下一篇
              </div>
              <a href="https://RookieYan.github.io/post/2020-04-21k3s-cong-0-da-jian/">
                <h3 class="post-title">
                  [2020-04-21]K3S从0搭建以及集成JenkinsCICD流程
                </h3>
              </a>
            </div>
          
        </div>
        
      </div>

      <div class="sm-12 md-4 col sidebar">
  <div class="paper info-container">
    <img src="https://RookieYan.github.io/images/avatar.png?v=1588359188349" class="no-responsive avatar">
    <div class="text-muted">一个白痴</div>
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
  </div>
  <div class="paper">
    <div class="sidebar-title">
      最新文章
    </div>
    <div class="row">
      <ul>
        
          
            <li>
              <a href="https://RookieYan.github.io/post/2020-04-18mysqler-redolog-he-binlog/"> [2020-04-18]MySQL（二）RedoLog和BinLog</a>
            </li>
          
        
          
            <li>
              <a href="https://RookieYan.github.io/post/2020-04-21k3s-cong-0-da-jian/">[2020-04-21]K3S从0搭建以及集成JenkinsCICD流程</a>
            </li>
          
        
          
            <li>
              <a href="https://RookieYan.github.io/post/2020-04-18mysqlyi-sql-de-zhi-xing-liu-cheng/">[2020-04-18]MySQL（一）SQL的执行流程</a>
            </li>
          
        
          
            <li>
              <a href="https://RookieYan.github.io/post/2020-04-11chong-xin-kai-shi/">[2020-04-11]重新开始</a>
            </li>
          
        
      </ul>
    </div>
  </div>
  <div class="paper">
    <div class="sidebar-title">
      标签列表
    </div>
    <div class="row">
      
        <a href="https://RookieYan.github.io/tag/A0v8BAYSM/" class="badge success">
          MySQL
        </a>
      
        <a href="https://RookieYan.github.io/tag/HAPk8628r/" class="badge success">
          K3S
        </a>
      
        <a href="https://RookieYan.github.io/tag/w5-hCCJiF/" class="badge ">
          心灵XX汤
        </a>
      
    </div>
  </div>
  <div class="paper">
    Powered by <a href="https://rookieyan.github.io/" target="_blank">闫</a> | <a class="rss" href="https://RookieYan.github.io/atom.xml" target="_blank">RSS</a>
  </div>
</div>


    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>

<script type="application/javascript">

AOS.init();

hljs.initHighlightingOnLoad()

</script>




  </body>
</html>
